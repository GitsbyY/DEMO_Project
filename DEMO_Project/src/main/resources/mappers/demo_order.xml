<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.demo.order">
	<resultMap type="orderDto" id="orderResultMap">
		<id column="ORDER_NO" property="orderNo" />
		<result column="MEMBER_NO" property="memberNo" />
		<result column="ORDER_DATE" property="orderDate"
			javaType="java.util.Date" />
		<result column="ORDER_REQUEST" property="orderRequest" />
		<result column="ORDER_STATUS" property="orderStatus" />
		<result column="PRODUCT_QUANTITY" property="productQuantity" />
	</resultMap>

	<resultMap type="orderConfirmDto" id="orderConfirmResultMap">
		<id column="ORDER_NO" property="orderNo" />
		<result column="ORDER_CONFIRM_DATE" property="orderConfirmDate"
			javaType="java.util.Date" />
	</resultMap>

	<resultMap type="orderCancelDto" id="orderCancelResultMap">
		<id column="ORDER_NO" property="orderNo" />
		<result column="ORDER_CANCEL_DATE" property="orderCancelDate"
			javaType="java.util.Date" />
	</resultMap>

	<select id="orderSelectList" parameterType="map"
		resultType="map">
		SELECT TL.RNUM, TL.ORDER_DATE, TL.ORDER_NO, TL.MEMBER_NO,
			TL.MEMBER_ID, TL.PRODUCT_NAME
		FROM(
			SELECT ROWNUM AS RNUM, OL.ORDER_DATE,
				OL.ORDER_NO, OL.MEMBER_NO, OL.PRODUCT_NO,
				OL.MEMBER_ID, OL.PRODUCT_NAME
			FROM ( SELECT L.ORDER_DATE, L.ORDER_NO,
						M.MEMBER_NO, P.PRODUCT_NO, M.MEMBER_ID, P.PRODUCT_NAME
					FROM ORDER_LIST L
					JOIN MEMBER M ON L.MEMBER_NO = M.MEMBER_NO
					JOIN PRODUCT P ON L.PRODUCT_NO = P.PRODUCT_NO
					ORDER BY ORDER_DATE DESC) OL
			<if test="category == 'memberNo'">
				WHERE OL.MEMBER_NO = #{search}
			</if>
			<if test="category == 'orderNo'">
				WHERE OL.ORDER_NO = #{search}
			</if>
			<if test="category == 'memberId'">
				WHERE OL.MEMBER_ID LIKE '%'||#{search}||'%'
			</if>
			<if test="category == 'productName'">
				WHERE OL.PRODUCT_NAME LIKE '%'||#{search}||'%'
			</if>
			) TL
		WHERE (TL.RNUM BETWEEN #{start} AND #{end})
		ORDER BY TL.RNUM ASC
	</select>
	
	<select id="memberOrderSelectList" parameterType="map"
		resultType="map">
		SELECT TL.RNUM, TL.ORDER_DATE, TL.ORDER_NO, TL.MEMBER_NO,
			TL.MEMBER_ID, TL.PRODUCT_NAME
		FROM(
			SELECT ROWNUM AS RNUM, OL.ORDER_DATE,
				OL.ORDER_NO, OL.MEMBER_NO, OL.PRODUCT_NO,
				OL.MEMBER_ID, OL.PRODUCT_NAME
			FROM ( SELECT L.ORDER_DATE, L.ORDER_NO,
						M.MEMBER_NO, P.PRODUCT_NO, M.MEMBER_ID, P.PRODUCT_NAME
					FROM ORDER_LIST L
					JOIN MEMBER M ON L.MEMBER_NO = M.MEMBER_NO
					JOIN PRODUCT P ON L.PRODUCT_NO = P.PRODUCT_NO
					WHERE M.MEMBER_NO = #{sessionMemberNo}
					ORDER BY ORDER_DATE DESC) OL
			<if test="category == 'orderNo'">
				WHERE OL.ORDER_NO = #{search}
			</if>
			<if test="category == 'productName'">
				WHERE OL.PRODUCT_NAME LIKE '%'||#{search}||'%'
			</if>
			) TL
		WHERE (TL.RNUM BETWEEN #{start} AND #{end})
		ORDER BY TL.RNUM ASC
	</select>

	<select id="orderSelectListTotalCount"
		resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM ORDER_LIST OL
		JOIN MEMBER M ON OL.MEMBER_NO = M.MEMBER_NO
		JOIN PRODUCT P ON OL.PRODUCT_NO = P.PRODUCT_NO
		<if test="category == 'memberNo'">
			WHERE M.MEMBER_NO = #{search}
		</if>
		<if test="category == 'orderNo'">
			WHERE OL.ORDER_NO = #{search}
		</if>
		<if test="category == 'memberId'">
			WHERE M.MEMBER_ID LIKE '%'||#{search}||'%'
		</if>
		<if test="category == 'productName'">
			WHERE P.PRODUCT_NAME LIKE '%'||#{search}||'%'
		</if>
	</select>
	
	<select id="memberOrderSelectListTotalCount"
		resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM ORDER_LIST OL
		JOIN MEMBER M ON OL.MEMBER_NO = M.MEMBER_NO
		JOIN PRODUCT P ON OL.PRODUCT_NO = P.PRODUCT_NO
		WHERE M.MEMBER_NO = #{sessionMemberNo}
		<if test="category == 'orderNo'">
			AND OL.ORDER_NO = #{search}
		</if>
		<if test="category == 'productName'">
			AND P.PRODUCT_NAME LIKE '%'||#{search}||'%'
		</if>
	</select>
	
	<select id="orderDetailSelectOne" resultType="map">
		SELECT
		OL.ORDER_DATE, OL.ORDER_NO, M.MEMBER_NO, M.MEMBER_ID
		, P.PRODUCT_NAME, PD.IMG_NO, PD.PRODUCT_DETAIL_CONTENT
		, P.PRODUCT_PRICE, OL.ORDER_STATUS
		FROM ORDER_LIST OL
		JOIN MEMBER M ON OL.MEMBER_NO = M.MEMBER_NO
		JOIN PRODUCT P ON OL.PRODUCT_NO = P.PRODUCT_NO
		JOIN PRODUCT_DETAIL PD ON P.PRODUCT_DETAIL_NO = PD.PRODUCT_DETAIL_NO
		WHERE OL.ORDER_NO = #{orderNo}
	</select>

	<update id="orderCancelUpdate" parameterType="java.lang.Integer">
		UPDATE ORDER_LIST
		SET ORDER_STATUS = '취소'
		WHERE ORDER_NO = #{orderNo}
	</update>

	<insert id="orderCancelInsert" parameterType="java.lang.Integer">
		INSERT INTO
		ORDER_CANCEL
		(ORDER_NO, ORDER_CANCEL_DATE)
		VALUES
		(#{orderNo}, SYSDATE)
	</insert>

	<select id="cancelSelectList" parameterType="map"
		resultType="map">
		SELECT ROWNUM AS RNUM, ORDER_NO, MEMBER_NO,
		MEMBER_ID, PRODUCT_NAME, ORDER_CANCEL_DATE, ORDER_STATUS
		FROM (
		SELECT OL.ORDER_NO,
		OL.MEMBER_NO, M.MEMBER_ID, P.PRODUCT_NAME
		,OC.ORDER_CANCEL_DATE, OL.ORDER_STATUS
		FROM
		ORDER_LIST OL
		JOIN MEMBER M ON OL.MEMBER_NO = M.MEMBER_NO
		JOIN PRODUCT P ON OL.PRODUCT_NO = P.PRODUCT_NO
		JOIN ORDER_CANCEL OC ON OL.ORDER_NO = OC.ORDER_NO
		ORDER BY OC.ORDER_CANCEL_DATE
		)
		WHERE (ORDER_STATUS = '취소') AND (ROWNUM BETWEEN #{start} AND #{end})
		AND
		<if test="category == 'memberNo'">
		 MEMBER_NO = TO_NUMBER(#{search})
		</if>
		<if test="category == 'orderNo'">
		 ORDER_NO = TO_NUMBER(#{search})
		</if>
		<if test="category == 'memberId'">
		 MEMBER_ID LIKE '%'||#{search}||'%'
		</if>
		<if test="category == 'productName'">
		 PRODUCT_NAME LIKE '%'||#{search}||'%'
		</if>
		ORDER BY ORDER_CANCEL_DATE
	</select>

	<select id="cancelSelectListMember" parameterType="map"
		resultType="map">
		SELECT ROWNUM AS RNUM, ORDER_NO, MEMBER_NO,
		MEMBER_ID, PRODUCT_NAME, ORDER_CANCEL_DATE, ORDER_STATUS
		FROM (
			SELECT OL.ORDER_NO,
			OL.MEMBER_NO, M.MEMBER_ID, P.PRODUCT_NAME
			,OC.ORDER_CANCEL_DATE, OL.ORDER_STATUS
			FROM
			ORDER_LIST OL
			JOIN MEMBER M ON OL.MEMBER_NO = M.MEMBER_NO
			JOIN PRODUCT P ON OL.PRODUCT_NO = P.PRODUCT_NO
			JOIN ORDER_CANCEL OC ON OL.ORDER_NO = OC.ORDER_NO
			ORDER BY OC.ORDER_CANCEL_DATE
		)
		WHERE MEMBER_NO = #{sessionMemberNo} 
		AND (ORDER_STATUS = '취소') AND (ROWNUM BETWEEN #{start} AND #{end})
		AND
		<if test="category == 'orderNo'">
		 ORDER_NO = TO_NUMBER(#{search})
		</if>
		<if test="category == 'productName'">
		 PRODUCT_NAME LIKE '%'||#{search}||'%'
		</if>
		ORDER BY ORDER_CANCEL_DATE
	</select>

	<select id="cancelSelectListTotalCount"
		resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM ORDER_LIST OL
		JOIN MEMBER M ON
		OL.MEMBER_NO = M.MEMBER_NO
		JOIN PRODUCT P ON OL.PRODUCT_NO = P.PRODUCT_NO
		JOIN ORDER_CANCEL OC ON OL.ORDER_NO = OC.ORDER_NO
	</select>
	
	<select id="cancelSelectListTotalCountMember"
		resultType="java.lang.Integer">
		SELECT COUNT(*)
		FROM ORDER_LIST OL
		JOIN MEMBER M ON
		OL.MEMBER_NO = M.MEMBER_NO
		JOIN PRODUCT P ON OL.PRODUCT_NO = P.PRODUCT_NO
		JOIN ORDER_CANCEL OC ON OL.ORDER_NO = OC.ORDER_NO
		WHERE M.MEMBER_NO = #{sessionMemberNo}
	</select>
	

	<select id="orderCancelDetailSelectOne" resultType="map">
		SELECT
		OL.ORDER_DATE, OL.ORDER_NO, M.MEMBER_NO, M.MEMBER_ID
		, P.PRODUCT_NAME, PD.IMG_NO, PD.PRODUCT_DETAIL_CONTENT
		,PR.PRODUCT_PRICE, OL.ORDER_STATUS, OC.ORDER_CANCEL_DATE
		FROM ORDER_LIST OL
		JOIN MEMBER M ON OL.MEMBER_NO = M.MEMBER_NO
		JOIN PRODUCT P ON OL.PRODUCT_NO = P.PRODUCT_NO
		JOIN PRODUCT PR ON P.PRODUCT_NO = PR.PRODUCT_NO
		JOIN PRODUCT_DETAIL PD ON PR.PRODUCT_DETAIL_NO = PD.PRODUCT_DETAIL_NO
		JOIN ORDER_CANCEL OC ON OL.ORDER_NO = OC.ORDER_NO
		WHERE OL.ORDER_NO = #{orderNo}
	</select>

</mapper>



